## 图片预览
### 兼容IE6的图片预览
```html
<input id="file_upload" type="file" />
<div class="image_container">
    <img id="preview" width="60" height="60">
</div>

<script type="text/javascript">
  $(function() {
      $("#file_upload").change(function() {
          var $file = $(this);
          var fileObj = $file[0];
          var windowURL = window.URL || window.webkitURL;
          var dataURL;
          var $img = $("#preview");

          if(fileObj && fileObj.files && fileObj.files[0]){
              dataURL = windowURL.createObjectURL(fileObj.files[0]);
              $img.attr('src',dataURL);
          }else{
             dataURL = $file.val();
             var imgObj = document.getElementById("preview");
          // 两个坑:
          // 1、在设置filter属性时，元素必须已经存在在DOM树中，动态创建的Node，也需要在设置属性前加入到DOM中，先设置属性在加入，无效；
          // 2、src属性需要像下面的方式添加，上面的两种方式添加，无效；
              imgObj.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
              imgObj.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = dataURL;

          }
      });
  });
</script>

```


```js
//原生ajax
var xhr = new XMLHttpRequest();
//发送完成并成功事件
xhr.onload = function() {
    if (xhr.responseText == 1) {
        //模态框提示
        $(".modal-body>.modal-main").html("发布成功");
        myModal.modal("show");
        setTimeout(function() {
            location.reload(true);
        }, 1000);
    } else {
        //模态框提示
        $(".modal-body>.modal-main").html("发布失败");
        myModal.modal("show");
    }
};
//提交失败事件
xhr.onerror = function() {
    //模态框提示
    $(".modal-body>.modal-main").html("发布失败");
    myModal.modal("show");
};
//post方式提交，异步
xhr.open('post', JSV.PATH_SERVER + 'Index/post_file', true);
//设置头部信息（post方式必须）
xhr.setRequestHeader('X-Request-With', 'XMLHttpRequest');
//获取files对象
var uploadFileBtn = $("#uploadFileBtn");
var filesObj = uploadFileBtn[0].files;
// //通过FormData来构建提交文件数据
var formData = new FormData();
//调用 append(name，value) 方法并传入相应的 File 对象作为参数(假设只有一个上传文件)
formData.append("photo", filesObj[0]);
var formTextData = requestData(formObj);
for (var key in formTextData) {
    formData.append(key, formTextData[key]);
}
//将formData作为参数调用send()方法
xhr.send(formData);
```
### 现代主流浏览器(IE10+):参考高三

```html
<input id="file_upload" type="file" />
<div class="image_container">
    <img id="preview" width="60" height="60">
</div>

<script type="text/javascript">
  var upload = document.querySelector("#file_upload");
  var preview = document.querySelector("#preview");
  // 1. 将图片转为base64,可将base64作为ajax传送数据（利用FileReader）
  upload.onchange = function(){
      var files = this.files;
      var reader = new FileReader();
      var (var i = 0,len = files.length; i < len; i++){
          reader.onload = function(e){
            preview.src = reader.result;
          };
          reader.readAsDataURL(files[i]);
      }
  }
  // 2.使用对象url
  upload.onchange = function(){
      var files = this.files;
      var windowUrl = window.URL || window.webkitURL;
      var (var i = 0,len = files.length; i < len; i++){
          preview.src = windowUrl.createObjectURL(files[i]);
      }
  }
</script>
```

## 使用 canvas 做缩略图

```js
var canvas = document.createElement("canvas");
var ctx = canvas.getContext("2d");
var MAX_WIDTH = 800;
var MAX_HEIGHT = 600;
var width = img.width;
var height = img.height;

if (width > height) {
  if (width > MAX_WIDTH) {
    height *= MAX_WIDTH / width;
    width = MAX_WIDTH;
  }
} else {
  if (height > MAX_HEIGHT) {
    width *= MAX_HEIGHT / height;
    height = MAX_HEIGHT;
  }
}
canvas.width = width;
canvas.height = height;
ctx.drawImage(img, 0, 0, width, height);
```
## 上传缩略图

```js
canvas.toBlob(function(blob) {
  var form = new FormData();
  form.append('file', blob);
  fetch('/api/upload', {method: 'POST', body: form});
});
```

**参考**：
- [HTML5 之图片上传预处理
](http://www.jianshu.com/p/823ceea1506c)
